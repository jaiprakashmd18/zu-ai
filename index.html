<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zu | Advanced AI Interface</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;500;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zu: {
                            base: '#030712', // Dark background
                            accent: '#00f3ff', // Cyan neon
                            secondary: '#7000ff', // Purple neon
                            glass: 'rgba(10, 10, 15, 0.6)',
                            glassHover: 'rgba(20, 20, 30, 0.8)',
                            border: 'rgba(0, 243, 255, 0.1)'
                        }
                    },
                    fontFamily: {
                        display: ['Orbitron', 'sans-serif'],
                        body: ['Rajdhani', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 12s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            height: 100%;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: all;
        }

        #app-container {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.6) 100%);
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(8, 8, 12, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-right: 1px solid rgba(0, 243, 255, 0.1);
        }

        .glass-modal {
            background: rgba(10, 14, 20, 0.9);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.15);
        }

        .chat-bubble-user {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-bubble-ai {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(112, 0, 255, 0.3);
            box-shadow: 0 0 20px rgba(112, 0, 255, 0.05);
        }

        /* Sidebar Transition */
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-closed {
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar-closed {
                transform: translateX(0); 
                width: 0;
                overflow: hidden;
                padding: 0;
                border: none;
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 243, 255, 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0, 243, 255, 0.5); }

        /* Typography & Effects */
        .typing-cursor::after {
            content: '▋';
            animation: blink 1s step-start infinite;
            color: #00f3ff;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }
        
        .glow-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.7); }
        .glow-border:focus-within {
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            border-color: rgba(0, 243, 255, 0.5);
        }

        /* Markdown Styles */
        .prose {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.05rem;
            line-height: 1.6;
            color: #e5e7eb;
        }
        .prose p { margin-bottom: 0.75em; }
        .prose strong { color: #00f3ff; font-weight: 600; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-family: 'Orbitron', sans-serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; }
        .prose h1 { font-size: 1.5em; border-bottom: 1px solid rgba(0, 243, 255, 0.3); padding-bottom: 0.2em; }
        .prose h2 { font-size: 1.3em; }
        .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; }
        .prose li { list-style: disc; marker: #00f3ff; }
        .prose code { background: rgba(0, 243, 255, 0.1); padding: 0.1em 0.3em; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; color: #00f3ff; }
        .prose pre { margin: 1em 0; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: #1e1e1e !important; }
        .prose pre code { background: transparent; padding: 0; color: inherit; font-size: 0.85em; display: block; }
        
        /* Copy Button in Code Blocks */
        .code-block-wrapper { position: relative; margin-top: 1rem; margin-bottom: 1rem; }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #aaa;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Fira Code', monospace;
            z-index: 5;
        }
        .copy-btn:hover { background: rgba(0, 243, 255, 0.2); color: #fff; border-color: #00f3ff; }

        /* Feature Chips */
        .feature-chip {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .feature-chip.active {
            background: rgba(0, 243, 255, 0.15);
            border-color: #00f3ff;
            color: #00f3ff;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

    </style>
</head>
<body>

    <!-- 3D Background -->
    <div id="canvas-container"></div>

    <!-- Main App Container -->
    <div id="app-container">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar absolute md:relative w-72 h-full glass-panel flex flex-col z-20 transform md:transform-none -translate-x-full md:translate-x-0 transition-all duration-300 border-r border-zu-border">
            
            <!-- Sidebar Header -->
            <div class="p-5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-zu-accent/10 border border-zu-accent/50 flex items-center justify-center animate-pulse">
                        <i data-lucide="box" class="w-5 h-5 text-zu-accent"></i>
                    </div>
                    <span class="font-display font-bold text-lg tracking-wider">ZU<span class="text-zu-secondary">.OS</span></span>
                </div>
                <button id="close-sidebar-mobile" class="md:hidden text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- New Chat Button -->
            <div class="px-4 mb-4">
                <button onclick="startNewChat()" class="w-full flex items-center gap-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-zu-accent/50 text-white p-3 rounded-lg transition-all group shadow-lg">
                    <i data-lucide="plus" class="w-5 h-5 text-zu-accent group-hover:rotate-90 transition-transform"></i>
                    <span class="font-body font-semibold">New Session</span>
                </button>
            </div>

            <!-- Deep Scan Feature (New) -->
            <div class="px-4 mb-2">
                <button onclick="runDeepScan()" class="w-full flex items-center gap-3 bg-zu-secondary/10 hover:bg-zu-secondary/20 border border-zu-secondary/30 hover:border-zu-secondary/60 text-white p-3 rounded-lg transition-all group">
                    <i data-lucide="activity" class="w-5 h-5 text-zu-secondary group-hover:animate-pulse"></i>
                    <span class="font-body font-semibold">✨ Deep Scan</span>
                </button>
            </div>

            <!-- History List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar px-2">
                <div class="px-2 pb-2">
                    <p class="text-[10px] font-mono text-gray-500 mb-3 uppercase tracking-widest pl-2">Memory Banks</p>
                    <div id="chat-history-list" class="space-y-1">
                        <!-- History items injected here -->
                    </div>
                </div>
            </div>

            <!-- User Footer -->
            <div class="p-4 border-t border-zu-border bg-black/20">
                <button id="settings-btn" class="flex items-center gap-3 w-full hover:bg-white/5 p-2 rounded-lg transition-colors group">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-zu-secondary to-zu-accent flex items-center justify-center shadow-[0_0_10px_rgba(0,243,255,0.3)]">
                        <span class="font-bold text-xs text-black">Zu</span>
                    </div>
                    <div class="text-left flex-1">
                        <p class="text-sm font-bold text-white group-hover:text-zu-accent transition-colors">Access</p>
                        <p id="api-status-text" class="text-[10px] text-gray-500">Local Mode</p>
                    </div>
                    <i data-lucide="settings" class="w-4 h-4 text-gray-400 group-hover:rotate-45 transition-transform"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative w-full h-full overflow-hidden">
            
            <!-- Top Bar -->
            <header class="h-16 flex items-center justify-between px-4 md:px-8 border-b border-zu-border bg-black/10 backdrop-blur-sm z-10">
                <div class="flex items-center gap-4">
                    <button id="toggle-sidebar" class="text-gray-300 hover:text-white transition-colors">
                        <i data-lucide="panel-left" class="w-6 h-6"></i>
                    </button>
                    <span id="current-chat-title" class="font-display text-sm md:text-base text-gray-300 tracking-wider opacity-80">NEW SESSION // V1.0</span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-status" class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-zu-accent/5 border border-zu-accent/20 transition-all duration-300">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                        <span class="text-xs font-mono text-gray-400">SIMULATION MODE</span>
                    </div>
                </div>
            </header>

            <!-- Chat Area -->
            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 scroll-smooth">
                
                <!-- Welcome/Empty State -->
                <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-100 transition-opacity duration-500">
                    <div class="w-24 h-24 mb-6 relative group cursor-pointer">
                        <div class="absolute inset-0 border-2 border-zu-accent/30 rounded-full animate-ping opacity-20"></div>
                        <div class="absolute inset-0 border border-zu-secondary/50 rounded-full animate-spin-slow group-hover:border-zu-accent transition-colors"></div>
                        <div class="absolute inset-2 bg-gradient-to-br from-zu-accent/20 to-zu-secondary/20 rounded-full backdrop-blur-md flex items-center justify-center">
                            <i data-lucide="cpu" class="w-10 h-10 text-zu-accent group-hover:scale-110 transition-transform"></i>
                        </div>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-display font-bold text-white mb-2 tracking-widest text-center">ZU <span class="text-zu-secondary">V1.0</span></h1>
                    <p class="text-gray-400 font-body text-xl max-w-md text-center mb-6">Advanced neural interface ready.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 w-full max-w-2xl px-4">
                        <button onclick="quickPrompt('Write a python script to calculate fibonacci sequence')" class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 hover:border-zu-accent/50 transition-all text-left group">
                            <h3 class="font-bold text-zu-accent mb-1 group-hover:text-white transition-colors">Code Generation</h3>
                            <p class="text-xs text-gray-400">Generate complex algorithms.</p>
                        </button>
                        <button onclick="quickPrompt('Explain quantum entanglement in simple terms')" class="p-4 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 hover:border-zu-secondary/50 transition-all text-left group">
                            <h3 class="font-bold text-zu-secondary mb-1 group-hover:text-white transition-colors">Data Analysis</h3>
                            <p class="text-xs text-gray-400">Synthesize complex information.</p>
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages-list" class="space-y-6 max-w-3xl mx-auto pb-4 hidden">
                    <!-- Messages injected here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 bg-gradient-to-t from-black via-black/90 to-transparent">
                <div class="max-w-3xl mx-auto relative glow-border rounded-2xl bg-black/40 backdrop-blur-xl border border-white/10 transition-all duration-300">
                    
                    <!-- Command Deck (New) -->
                    <div class="flex gap-2 px-4 pt-3 pb-1 overflow-x-auto custom-scrollbar">
                        <button onclick="setMode('STRATEGIZE')" id="mode-strategize" class="feature-chip flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-400 hover:text-white whitespace-nowrap">
                            <i data-lucide="crosshair" class="w-3 h-3"></i> ✨ STRATEGIZE
                        </button>
                        <button onclick="setMode('DECRYPT')" id="mode-decrypt" class="feature-chip flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-400 hover:text-white whitespace-nowrap">
                            <i data-lucide="zap" class="w-3 h-3"></i> ✨ DECRYPT
                        </button>
                        <button onclick="setMode('CODEX')" id="mode-codex" class="feature-chip flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-gray-400 hover:text-white whitespace-nowrap">
                            <i data-lucide="code-2" class="w-3 h-3"></i> ✨ CODEX
                        </button>
                    </div>

                    <textarea 
                        id="user-input" 
                        rows="1" 
                        class="w-full bg-transparent text-white p-4 pr-12 rounded-b-2xl resize-none outline-none font-body text-lg max-h-40 placeholder-gray-600 custom-scrollbar"
                        placeholder="Send a command to Zu..."
                    ></textarea>
                    
                    <button id="send-btn" class="absolute right-2 bottom-2 p-2 bg-zu-accent hover:bg-white text-black rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="text-center mt-2 flex justify-center gap-4">
                    <p class="text-[10px] text-gray-600 font-mono">ZU V1.0 // SYSTEM OPTIMAL</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="glass-modal w-full max-w-lg rounded-2xl p-8 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <i data-lucide="settings" class="w-6 h-6 text-zu-accent"></i>
                    <h2 class="font-display text-2xl font-bold">SYSTEM CONFIG</h2>
                </div>
                <button id="close-settings" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-8">
                <!-- API Key Section -->
                <div>
                    <label class="text-xs font-mono text-zu-accent uppercase mb-2 block flex items-center gap-2">
                        <i data-lucide="key" class="w-3 h-3"></i> Neural Link (Zu API Key)
                    </label>
                    <p class="text-xs text-gray-500 mb-3">Connect Zu. Key is stored locally in your browser.</p>
                    <div class="relative">
                        <input type="password" id="api-key-input" placeholder="AIza..." class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-zu-accent focus:outline-none font-mono text-sm">
                        <button id="save-key-btn" class="absolute right-2 top-2 px-3 py-1 bg-zu-accent/10 hover:bg-zu-accent text-zu-accent hover:text-black rounded text-xs font-bold transition-all">CONNECT</button>
                    </div>
                    <div id="key-status-msg" class="text-xs mt-2 h-4"></div>
                </div>

                <!-- Model Selector (New) -->
                <div>
                    <label class="text-xs font-mono text-zu-accent uppercase mb-2 block flex items-center gap-2">
                        <i data-lucide="cpu" class="w-3 h-3"></i> AI Model Core
                    </label>
                    <p class="text-xs text-gray-500 mb-3">Select the specific neural model compatible with your API key.</p>
                    <select id="model-select" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-zu-accent focus:outline-none font-mono text-sm">
                        <option value="gemini-2.5-flash-preview-09-2025">Zu-1.5-flash (Latest Preview)</option>
                        <option value="gemini-1.5-flash">Zu-1.0-flash (Standard)</option>
                        <option value="gemini-1.5-pro">Zu-1.0-pro (Advanced)</option>
                        <option value="gemini-pro">Zu-pro (Legacy)</option>
                    </select>
                </div>

                <!-- Voice Toggle -->
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/10">
                    <div>
                        <span class="text-sm font-bold text-white block">Vocal Synthesis</span>
                        <span class="text-xs text-gray-500">Enable Neural Voice (Browser TTS)</span>
                    </div>
                    <button id="toggle-voice-btn" class="w-10 h-5 bg-gray-600 rounded-full relative transition-colors duration-300">
                        <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300"></div>
                    </button>
                </div>

                <div class="border-t border-white/10 pt-6">
                    <label class="text-xs font-mono text-zu-secondary uppercase mb-2 block">Data Management</label>
                    <button onclick="clearAllHistory()" class="w-full p-3 border border-red-500/30 bg-red-500/5 text-red-400 hover:bg-red-500/10 hover:border-red-500 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 group">
                        <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                        PURGE ALL MEMORY BANKS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons & Highlight.js
        lucide.createIcons();
        marked.setOptions({
            highlight: function(code, lang) {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        // -----------------------------------------------------------------------------
        // THREE.JS BACKGROUND
        // -----------------------------------------------------------------------------
        const initThreeJS = () => {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0015);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Dynamic Particle Field
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 2000;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i = 0; i < particlesCount * 3; i++) posArray[i] = (Math.random() - 0.5) * 150;
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            
            const particlesMaterial = new THREE.PointsMaterial({
                size: 0.12,
                color: 0x00f3ff,
                transparent: true,
                opacity: 0.5,
                blending: THREE.AdditiveBlending
            });
            const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particlesMesh);

            // Core Structure
            const coreGeo = new THREE.IcosahedronGeometry(10, 1);
            const coreMat = new THREE.MeshBasicMaterial({ 
                color: 0x7000ff, 
                wireframe: true, 
                transparent: true, 
                opacity: 0.05 
            });
            const core = new THREE.Mesh(coreGeo, coreMat);
            scene.add(core);

            // Outer Ring
            const ringGeo = new THREE.TorusGeometry(16, 0.05, 16, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff, transparent: true, opacity: 0.1 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 2;
            scene.add(ring);

            let mouseX = 0, mouseY = 0;
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX - windowHalfX) * 0.0005;
                mouseY = (e.clientY - windowHalfY) * 0.0005;
            });

            const animate = () => {
                requestAnimationFrame(animate);
                core.rotation.y += 0.002;
                core.rotation.z += 0.001;
                ring.rotation.z -= 0.002;
                
                // Gentle sway based on mouse
                core.rotation.y += 0.05 * (mouseX - core.rotation.y);
                core.rotation.x += 0.05 * (mouseY - core.rotation.x);
                
                // Particles drift
                particlesMesh.rotation.y = mouseX * 0.1;
                particlesMesh.rotation.x = mouseY * 0.1;

                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };
        initThreeJS();

        // -----------------------------------------------------------------------------
        // STATE MANAGEMENT
        // -----------------------------------------------------------------------------
        let chats = JSON.parse(localStorage.getItem('zu_chats')) || [];
        let storedApiKey = localStorage.getItem('zu_gemini_key') || null;
        let storedModel = localStorage.getItem('zu_model') || 'Zu Activated';
        let voiceEnabled = localStorage.getItem('zu_voice_enabled') === 'true';
        let currentChatId = null;
        let isGenerating = false;
        let activeMode = null; // STRATEGIZE, DECRYPT, CODEX

        // UI Elements
        const ui = {
            messagesList: document.getElementById('messages-list'),
            emptyState: document.getElementById('empty-state'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            historyList: document.getElementById('chat-history-list'),
            chatTitle: document.getElementById('current-chat-title'),
            sidebar: document.getElementById('sidebar'),
            connectionStatus: document.getElementById('connection-status'),
            keyInput: document.getElementById('api-key-input'),
            apiStatusText: document.getElementById('api-status-text'),
            voiceToggle: document.getElementById('toggle-voice-btn'),
            modelSelect: document.getElementById('model-select')
        };

        // Initialize Model Selector
        ui.modelSelect.value = storedModel;

        // -----------------------------------------------------------------------------
        // LOGIC: MODES & COMMAND DECK
        // -----------------------------------------------------------------------------
        window.setMode = (mode) => {
            // Toggle off if clicking same mode
            if (activeMode === mode) {
                activeMode = null;
                document.querySelectorAll('.feature-chip').forEach(el => el.classList.remove('active'));
                return;
            }

            activeMode = mode;
            document.querySelectorAll('.feature-chip').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${mode.toLowerCase()}`).classList.add('active');
        };

        const getSystemPromptForMode = (mode, userText) => {
            const basePrompt = "You are Zu, a highly advanced, futuristic AI interface v2.5. You prefer technical, concise, and slightly robotic but helpful language. Use Markdown.";
            
            switch(mode) {
                case 'STRATEGIZE':
                    return `${basePrompt} \n\nTASK: Act as a master strategic planner. Create a comprehensive, step-by-step execution plan for the user's request: "${userText}". Focus on logistics, resources, and milestones.`;
                case 'DECRYPT':
                    return `${basePrompt} \n\nTASK: Act as a master educator. Explain the following concept/text in the simplest possible terms, using analogies: "${userText}".`;
                case 'CODEX':
                    return `${basePrompt} \n\nTASK: Act as a senior software architect. Provide optimized, clean, and well-commented code for: "${userText}". Do not provide lengthy explanations, just the solution.`;
                case 'SCAN':
                     return `${basePrompt} \n\nTASK: Analyze the following conversation history and provide a high-level diagnostic summary of the user's goals, key topics discussed, and suggested next steps.`;
                default:
                    return `${basePrompt} \n\nUser: ${userText}`;
            }
        };

        // -----------------------------------------------------------------------------
        // LOGIC: DEEP SCAN
        // -----------------------------------------------------------------------------
        async function runDeepScan() {
            if (!currentChatId || !chats.find(c => c.id === currentChatId)) {
                alert("No active session to scan.");
                return;
            }
            
            // Get current chat history text
            const chat = chats.find(c => c.id === currentChatId);
            const historyText = chat.messages.map(m => `${m.sender.toUpperCase()}: ${m.text}`).join('\n');
            
            // Trigger UI
            appendMessageToUI("Initiating Deep Scan protocol on current neural pathways...", 'ai');
            
            // Fetch
            isGenerating = true;
            const prompt = `HISTORY_LOG:\n${historyText}`;
            const response = await fetchAIResponse(prompt, 'SCAN');
            
            // Result
            chat.messages.push({ text: response, sender: 'ai', timestamp: Date.now() });
            localStorage.setItem('zu_chats', JSON.stringify(chats));
            appendMessageToUI(response, 'ai');
        }

        // -----------------------------------------------------------------------------
        // LOGIC: SETTINGS & API KEY & VOICE
        // -----------------------------------------------------------------------------
        const updateConnectionStatus = () => {
            if (storedApiKey) {
                const indicator = ui.connectionStatus.querySelector('div');
                const text = ui.connectionStatus.querySelector('span');
                
                indicator.className = 'w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.8)] animate-pulse';
                text.textContent = 'Zu LINK: ACTIVE';
                text.classList.add('text-green-500', 'font-bold');
                
                ui.apiStatusText.textContent = `Online: ${storedModel}`;
                ui.apiStatusText.className = 'text-[10px] text-green-400';
            } else {
                ui.connectionStatus.querySelector('div').className = 'w-2 h-2 bg-yellow-500 rounded-full';
                ui.connectionStatus.querySelector('span').textContent = 'SIMULATION MODE';
                ui.connectionStatus.querySelector('span').classList.remove('text-green-500', 'font-bold');
                ui.apiStatusText.textContent = 'Local Simulation';
                ui.apiStatusText.className = 'text-[10px] text-gray-500';
            }
        };

        const updateVoiceUI = () => {
            const btn = ui.voiceToggle;
            const knob = btn.querySelector('div');
            if (voiceEnabled) {
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-zu-accent');
                knob.classList.add('translate-x-5');
            } else {
                btn.classList.add('bg-gray-600');
                btn.classList.remove('bg-zu-accent');
                knob.classList.remove('translate-x-5');
            }
        };

        ui.voiceToggle.addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            localStorage.setItem('zu_voice_enabled', voiceEnabled);
            updateVoiceUI();
        });

        // Model Selector Logic
        ui.modelSelect.addEventListener('change', (e) => {
            storedModel = e.target.value;
            localStorage.setItem('zu_model', storedModel);
            updateConnectionStatus(); // Update status text
        });

        document.getElementById('save-key-btn').addEventListener('click', () => {
            const val = ui.keyInput.value.trim();
            const msg = document.getElementById('key-status-msg');
            
            if (val.length > 20) {
                storedApiKey = val;
                localStorage.setItem('zu_gemini_key', val);
                msg.textContent = 'Authentication Successful. Zu Core Synced.';
                msg.className = 'text-xs mt-2 h-4 text-green-400 font-mono';
                updateConnectionStatus();
                setTimeout(() => {
                    document.getElementById('settings-modal').classList.add('hidden');
                    msg.textContent = '';
                }, 1000);
            } else {
                msg.textContent = 'Invalid Key Format. Please check your Zu API key.';
                msg.className = 'text-xs mt-2 h-4 text-red-400 font-mono';
            }
        });

        // Toggle Settings
        document.getElementById('settings-btn').addEventListener('click', () => {
            const modal = document.getElementById('settings-modal');
            ui.keyInput.value = storedApiKey || '';
            ui.modelSelect.value = storedModel; // Sync dropdown
            updateVoiceUI();
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        });

        // -----------------------------------------------------------------------------
        // LOGIC: CHAT & API INTEGRATION
        // -----------------------------------------------------------------------------
        
        async function fetchAIResponse(userMessage, mode = null) {
            // 1. REAL API MODE (GEMINI)
            if (storedApiKey) {
                try {
                    const finalPrompt = getSystemPromptForMode(mode || activeMode, userMessage);

                    // Use stored model (fallback to 2.5-flash if somehow empty)
                    const model = storedModel || 'gemini-2.5-flash-preview-09-2025'; 
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${storedApiKey}`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: finalPrompt }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        // User-friendly Error Handling for 404
                        if (data.error.code === 404) {
                            throw new Error(`Model '${model}' not found for your API key. Please change the 'AI Model Core' in Settings.`);
                        }
                        throw new Error(data.error.message);
                    }
                    
                    if (!data.candidates || data.candidates.length === 0) {
                        return "Zu Core: Input blocked by safety filters. Please adjust your query.";
                    }

                    // Gemini Response Extraction
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error("API Error:", error);
                    return `**SYSTEM ERROR:** Connection to Zu cloud failed.\n\n\`${error.message}\`\n\n**Tip:** Go to Settings -> AI Model Core and try switching to a different model (e.g.,Zu-1.5-flash or Zu-pro).`;
                }
            }

            // 2. SIMULATION MODE (Fallback)
            return new Promise(resolve => {
                setTimeout(() => {
                    const lower = userMessage.toLowerCase();
                    if (mode) resolve(`**[SIMULATION: ${mode}]**\n\nThis is a simulated ${mode} response. To unlock real AI intelligence, please connect your Zu API key.`);
                    else if (lower.includes('hello')) resolve("System Online. Greetings, User. I am **Zu v1.5**. My local processing nodes are active. Connect a Neural Link (Zu API Key) for full cognitive capacity.");
                    else resolve(`**Input Received:** "${userMessage}"\n\nI am currently running in **Simulation Mode**. To unlock my full potential (including complex reasoning, code generation, and world knowledge), please enter your Google Gemini API Key in the **Settings** menu.`);
                }, 1000);
            });
        }

        // -----------------------------------------------------------------------------
        // UI MANIPULATION
        // -----------------------------------------------------------------------------

        function createChatId() { return 'chat_' + Date.now(); }

        function renderHistory() {
            ui.historyList.innerHTML = '';
            const sortedChats = [...chats].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedChats.forEach(chat => {
                const btn = document.createElement('button');
                const isActive = chat.id === currentChatId;
                btn.className = `w-full text-left p-3 rounded-lg text-sm transition-all flex items-center gap-2 group mb-1 ${
                    isActive ? 'bg-zu-accent/10 text-white border border-zu-accent/30' : 'text-gray-400 hover:text-white hover:bg-white/5'
                }`;
                btn.onclick = () => loadChat(chat.id);
                btn.innerHTML = `
                    <i data-lucide="message-square" class="w-4 h-4 ${isActive ? 'text-zu-accent' : 'text-gray-600 group-hover:text-zu-accent'}"></i>
                    <span class="truncate w-full font-body tracking-wide">${chat.title || 'New Session'}</span>
                `;
                ui.historyList.appendChild(btn);
            });
            lucide.createIcons();
        }

        function startNewChat() {
            currentChatId = createChatId();
            ui.messagesList.innerHTML = '';
            ui.messagesList.classList.add('hidden');
            ui.emptyState.classList.remove('hidden');
            ui.chatTitle.textContent = "NEW SESSION // V1.0";
            ui.userInput.value = '';
            
            // Reset Modes
            activeMode = null;
            document.querySelectorAll('.feature-chip').forEach(el => el.classList.remove('active'));

            if(window.innerWidth < 768) toggleSidebar(false);
            renderHistory();
        }

        function loadChat(id) {
            const chat = chats.find(c => c.id === id);
            if (!chat) return;
            currentChatId = id;
            ui.messagesList.innerHTML = '';
            
            if (chat.messages.length > 0) {
                ui.emptyState.classList.add('hidden');
                ui.messagesList.classList.remove('hidden');
                chat.messages.forEach(msg => appendMessageToUI(msg.text, msg.sender, false));
                ui.chatTitle.textContent = (chat.title || "SESSION RESTORED").toUpperCase();
            } else {
                ui.emptyState.classList.remove('hidden');
                ui.messagesList.classList.add('hidden');
            }
            if(window.innerWidth < 768) toggleSidebar(false);
            renderHistory();
        }

        function appendMessageToUI(text, sender, animate = true) {
            ui.emptyState.classList.add('hidden');
            ui.messagesList.classList.remove('hidden');

            const div = document.createElement('div');
            const isUser = sender === 'user';
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-[slideIn_0.3s_ease-out]`;
            
            // Markdown Parsing for AI
            const formattedContent = isUser ? text : marked.parse(text);

            div.innerHTML = `
                <div class="flex max-w-[90%] md:max-w-[75%] gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}">
                    <div class="w-8 h-8 rounded-sm flex items-center justify-center flex-shrink-0 mt-1 ${
                        isUser ? 'bg-white/10' : 'bg-gradient-to-br from-zu-secondary to-zu-base border border-zu-secondary/50'
                    }">
                        ${isUser ? '<i data-lucide="user" class="w-4 h-4 text-gray-300"></i>' : '<i data-lucide="cpu" class="w-4 h-4 text-white"></i>'}
                    </div>
                    
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} w-full min-w-0">
                        <span class="text-[10px] font-mono text-gray-500 mb-1 tracking-wider">${isUser ? 'USER_ID_01' : 'ZU_CORE_V1.0'}</span>
                        <div class="px-5 py-3 rounded-2xl text-base leading-relaxed ${
                            isUser 
                            ? 'chat-bubble-user text-gray-100 rounded-tr-sm font-body' 
                            : 'chat-bubble-ai text-gray-100 rounded-tl-sm prose prose-invert w-full max-w-none'
                        }">
                            ${!isUser && animate ? '<span class="typing-target"></span>' : formattedContent}
                        </div>
                    </div>
                </div>
            `;

            ui.messagesList.appendChild(div);
            lucide.createIcons();
            
            // Apply highlighting to static content
            if (!animate || isUser) {
                div.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                    addCopyButton(block.parentElement);
                });
            }

            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;

            if (!isUser && animate) {
                typeWriter(div.querySelector('.typing-target'), text, container, div);
                if (voiceEnabled) speakText(text); // Trigger Voice
            }
        }

        // Voice Synthesis (Browser API for Stability in v1.0)
        function speakText(text) {
            // Strip markdown chars for cleaner speech
            const cleanText = text.replace(/[*#`]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            // Try to find a futuristic/robotic voice if available
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
            if(preferredVoice) utterance.voice = preferredVoice;
            
            utterance.pitch = 0.9; // Slightly deeper
            utterance.rate = 1.05; // Slightly faster
            window.speechSynthesis.speak(utterance);
        }

        // Add Copy Button to Code Blocks
        function addCopyButton(preElement) {
            if (preElement.querySelector('.copy-btn')) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            preElement.parentNode.insertBefore(wrapper, preElement);
            wrapper.appendChild(preElement);

            const btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.innerHTML = 'COPY';
            
            btn.addEventListener('click', () => {
                const code = preElement.querySelector('code').innerText;
                navigator.clipboard.writeText(code);
                btn.innerHTML = 'COPIED!';
                btn.style.borderColor = '#00f3ff';
                btn.style.color = '#fff';
                setTimeout(() => {
                    btn.innerHTML = 'COPY';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 2000);
            });
            
            wrapper.appendChild(btn);
        }

        function typeWriter(element, rawText, scrollContainer, parentDiv) {
            element.classList.add('typing-cursor');
            let i = 0;
            isGenerating = true;
            ui.sendBtn.disabled = true;
            
            const speed = 10; 

            function type() {
                if (i < rawText.length) {
                    element.textContent += rawText.charAt(i);
                    i++;
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                    if(i % 5 === 0) requestAnimationFrame(type); 
                    else setTimeout(type, speed); 
                } else {
                    element.classList.remove('typing-cursor');
                    element.parentElement.innerHTML = marked.parse(rawText);
                    
                    parentDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        addCopyButton(block.parentElement);
                    });

                    isGenerating = false;
                    ui.sendBtn.disabled = false;
                    if(window.innerWidth > 768) ui.userInput.focus();
                }
            }
            type();
        }

        async function handleSend() {
            const text = ui.userInput.value.trim();
            if (!text || isGenerating) return;

            ui.userInput.value = '';
            ui.userInput.style.height = 'auto';
            
            // 1. Save & Show User Msg
            let chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                chat = {
                    id: currentChatId,
                    title: text.length > 20 ? text.substring(0, 20) + '...' : text,
                    timestamp: Date.now(),
                    messages: []
                };
                chats.push(chat);
                ui.chatTitle.textContent = chat.title.toUpperCase();
                renderHistory();
            }
            
            // If active mode, append mode tag to user message for history clarity
            const displayMode = activeMode ? `[${activeMode}] ` : '';
            
            chat.messages.push({ text: displayMode + text, sender: 'user', timestamp: Date.now() });
            localStorage.setItem('zu_chats', JSON.stringify(chats));
            appendMessageToUI(displayMode + text, 'user');

            // 2. Fetch AI (passing activeMode)
            isGenerating = true;
            const response = await fetchAIResponse(text, activeMode);

            // 3. Save & Show AI Msg
            chat.messages.push({ text: response, sender: 'ai', timestamp: Date.now() });
            chat.timestamp = Date.now();
            localStorage.setItem('zu_chats', JSON.stringify(chats));
            renderHistory(); 
            
            appendMessageToUI(response, 'ai');
            
            // Reset mode after one-shot use (optional, keeping it sticky or not is a UX choice. Let's keep it sticky for flow)
            // if(activeMode) setMode(activeMode); // It stays active.
        }

        // Helpers
        window.quickPrompt = (text) => {
            ui.userInput.value = text;
            handleSend();
        };

        window.clearAllHistory = () => {
            if(confirm("WARNING: Irreversible data purge initiated. Confirm?")) {
                chats = [];
                localStorage.removeItem('zu_chats');
                startNewChat();
                document.getElementById('settings-modal').classList.add('hidden');
            }
        };

        // Sidebar Toggles
        const toggleSidebar = (forceOpen) => {
            const sb = ui.sidebar;
            if (window.innerWidth >= 768) {
                if (forceOpen === false || (!forceOpen && sb.style.width === '')) {
                    sb.style.width = '0px'; 
                    sb.style.padding = '0';
                    sb.style.border = 'none';
                    sb.style.overflow = 'hidden';
                } else {
                    sb.style.width = '';
                    sb.style.padding = '';
                    sb.style.border = '';
                }
            } else {
                sb.classList.toggle('-translate-x-full');
            }
        };

        document.getElementById('toggle-sidebar').addEventListener('click', () => toggleSidebar());
        document.getElementById('close-sidebar-mobile').addEventListener('click', () => ui.sidebar.classList.add('-translate-x-full'));

        // Input Handling
        ui.userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        ui.userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        ui.sendBtn.addEventListener('click', handleSend);

        // Init
        startNewChat();
        updateConnectionStatus();
        updateVoiceUI();

    </script>
</body>
</html>



