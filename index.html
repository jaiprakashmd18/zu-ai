<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zu | Dual-Core AI Interface</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(10, 10, 12, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-primary: #00f3ff;
            --neon-secondary: #bc13fe;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--text-primary);
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: all;
        }

        #ui-layer {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            background: radial-gradient(circle at center, transparent 0%, #000000 120%);
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        .glass-sidebar {
            background: rgba(5, 5, 8, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Typing Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            background-color: var(--neon-primary);
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Message Styles */
        .msg-content {
            font-family: 'Space Grotesk', sans-serif;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .msg-content p { margin-bottom: 0.5rem; }
        .msg-content p:last-child { margin-bottom: 0; }
        .msg-content code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #ff79c6;
            font-size: 0.9em;
        }
        .msg-content pre {
            background: rgba(0,0,0,0.4);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid var(--glass-border);
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .msg-content pre code {
            background: transparent;
            padding: 0;
            color: #f8f8f2;
        }
        .msg-content img {
            max-width: 100%;
            border-radius: 0.5rem;
            border: 1px solid var(--glass-border);
            margin-top: 0.5rem;
        }
        .msg-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .msg-content th, .msg-content td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            text-align: left;
        }
        .msg-content th { background: rgba(255, 255, 255, 0.05); }

        /* Input Area Glow */
        .input-wrapper:focus-within {
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.15);
            border-color: rgba(0, 243, 255, 0.3);
        }

        .logo-text {
            background: linear-gradient(135deg, #fff 0%, #00f3ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -1px;
        }

        /* Sparkle Button Gradient */
        .btn-sparkle {
            background: linear-gradient(135deg, rgba(188, 19, 254, 0.1) 0%, rgba(0, 243, 255, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-sparkle:hover {
            background: linear-gradient(135deg, rgba(188, 19, 254, 0.2) 0%, rgba(0, 243, 255, 0.2) 100%);
            border-color: rgba(0, 243, 255, 0.4);
            box-shadow: 0 0 15px rgba(188, 19, 254, 0.2);
        }
        
        .history-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 2px solid var(--neon-primary);
        }
        
        /* Mobile Sidebar Toggle Logic */
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                height: 100%;
                z-index: 50;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>

    <!-- 3D Background Container -->
    <div id="canvas-container"></div>

    <!-- UI Layer -->
    <div id="ui-layer">
        
        <!-- Sidebar -->
        <aside class="glass-sidebar w-72 flex flex-col transition-transform duration-300 md:translate-x-0" id="sidebar">
            <!-- Header -->
            <div class="p-5 flex items-center justify-between border-b border-white/10 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold shadow-[0_0_15px_rgba(6,182,212,0.5)]">
                        Z
                    </div>
                    <span class="text-2xl logo-text">Zu</span>
                </div>
                <!-- Mobile Close Button -->
                <button class="md:hidden text-gray-400" onclick="document.getElementById('sidebar').classList.remove('open')">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Scrollable Middle Section (Tools + History) -->
            <div class="flex-1 overflow-y-auto min-h-0">
                <!-- Neural Tools -->
                <div class="p-4 space-y-3">
                    <div class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest px-1">Neural Modules</div>
                    
                    <button onclick="startNewChat()" class="w-full text-left px-3 py-2.5 rounded-lg border border-white/10 hover:bg-white/5 text-sm text-gray-300 transition-colors flex items-center gap-2 mb-2">
                        <i data-lucide="plus" class="w-4 h-4 text-green-400"></i>
                        <span>New Session</span>
                    </button>

                    <button onclick="triggerTool('visualizer')" class="btn-sparkle w-full text-left px-3 py-3 rounded-lg text-sm text-gray-200 transition-all flex items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="image" class="w-4 h-4 text-pink-400"></i>
                        <div class="flex flex-col">
                            <span class="font-medium">✨ Visualizer</span>
                            <span class="text-[10px] text-gray-500">Generate imagery</span>
                        </div>
                    </button>

                    <button onclick="triggerTool('strategist')" class="btn-sparkle w-full text-left px-3 py-3 rounded-lg text-sm text-gray-200 transition-all flex items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="crosshair" class="w-4 h-4 text-cyan-400"></i>
                        <div class="flex flex-col">
                            <span class="font-medium">✨ Strategist</span>
                            <span class="text-[10px] text-gray-500">Plan execution</span>
                        </div>
                    </button>
                    
                    <button onclick="triggerTool('code_weaver')" class="btn-sparkle w-full text-left px-3 py-3 rounded-lg text-sm text-gray-200 transition-all flex items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="terminal" class="w-4 h-4 text-emerald-400"></i>
                        <div class="flex flex-col">
                            <span class="font-medium">✨ Code Weaver</span>
                            <span class="text-[10px] text-gray-500">Generate software</span>
                        </div>
                    </button>

                    <button onclick="triggerTool('mind_reader')" class="btn-sparkle w-full text-left px-3 py-3 rounded-lg text-sm text-gray-200 transition-all flex items-center gap-3 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i data-lucide="microscope" class="w-4 h-4 text-purple-400"></i>
                        <div class="flex flex-col">
                            <span class="font-medium">✨ Mind Reader</span>
                            <span class="text-[10px] text-gray-500">Analyze subtext</span>
                        </div>
                    </button>
                </div>

                <!-- History Section -->
                <div class="p-3 pt-0 border-t border-white/5">
                    <div class="flex items-center justify-between px-2 mb-2 mt-4">
                        <span class="text-[10px] font-medium text-gray-600 uppercase tracking-widest">Memory Banks</span>
                        <button onclick="clearHistory()" class="text-[10px] text-red-400 hover:text-red-300">CLEAR ALL</button>
                    </div>
                    <div id="history-list" class="space-y-1 pb-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- System Status (Automated) -->
            <div class="p-4 border-t border-white/10 shrink-0 bg-black/20">
                <button onclick="checkStatusForce()" class="w-full flex items-center justify-between px-3 py-2 rounded-lg border border-white/5 bg-white/5 hover:bg-white/10 transition-colors">
                    <div class="flex items-center gap-3">
                        <div id="status-indicator" class="w-2 h-2 rounded-full bg-gray-500 transition-all duration-300"></div>
                        <span id="status-label" class="text-xs font-mono text-gray-400 transition-colors">INITIALIZING...</span>
                    </div>
                    <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-600"></i>
                </button>
                <div id="model-badge" class="text-[10px] text-center mt-2 text-gray-600 font-mono">DUAL-CORE SYSTEM</div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col relative h-full w-full">
            
            <!-- Header (Mobile Toggle) -->
            <header class="h-16 flex items-center justify-between px-6 border-b border-white/5 bg-transparent md:bg-opacity-0 z-20 shrink-0">
                <button class="md:hidden text-gray-400 hover:text-white" onclick="document.getElementById('sidebar').classList.add('open')">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center gap-2 ml-auto">
                    <span class="text-xs font-mono text-cyan-400/70 border border-cyan-900/50 px-2 py-1 rounded bg-cyan-950/30">CORE: ZU-DUAL-V2</span>
                </div>
            </header>

            <!-- Messages Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 z-10">
                <!-- Welcome Message (Generated by JS on new chat) -->
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 pb-8 z-20 shrink-0">
                <div class="max-w-3xl mx-auto relative input-wrapper rounded-xl border border-white/10 bg-black/40 backdrop-blur-xl transition-all duration-300">
                    <form id="chat-form" class="flex items-end gap-2 p-2">
                        <!-- Hidden File Input -->
                        <input type="file" id="file-input" class="hidden" accept=".txt,.js,.py,.html,.css,.md,.json">
                        
                        <button type="button" onclick="document.getElementById('file-input').click()" class="p-2 text-gray-400 hover:text-cyan-400 transition-colors" title="Upload Text Context">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>
                        
                        <textarea 
                            id="user-input"
                            rows="1"
                            placeholder="Message Zu..."
                            class="flex-1 bg-transparent border-0 focus:ring-0 text-white placeholder-gray-500 resize-none py-3 max-h-32 scrollbar-hide font-sans outline-none"
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        ></textarea>
                        
                        <button type="submit" class="p-2 rounded-lg bg-cyan-600/20 text-cyan-400 hover:bg-cyan-500 hover:text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-600">Zu Interface can make mistakes. Verify important information.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        // --- CONFIGURATION ---
        
        // 1. Primary Core (Default)
        const primaryKey = "AIzaSyC1Rong6FrP5GhexGLe1FMdqJHi7ePA-ZE"; 
        
        // 2. Secondary Core (Auxiliary Fallback)
        // Add your auxiliary key here if you have one.
        const secondaryKey = ""; 

        // --- GLOBAL STATE ---
        let sessionId = Date.now().toString();
        let history = []; 
        let savedSessions = JSON.parse(localStorage.getItem('zu_sessions') || '{}');
        let currentToolState = 'idle'; 
        let isOnline = true; 
        let activeModel = "PRIMARY"; // Tracks which model last replied

        // --- THREE.JS BACKGROUND (Cybernetic Core) ---
        const initThreeJS = () => {
            const container = document.getElementById('canvas-container');
            if(!container) return;
            
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 40;

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // GROUP: Cyber Core
            const cyberGroup = new THREE.Group();
            scene.add(cyberGroup);

            // 1. Central Wireframe Sphere
            const coreGeo = new THREE.IcosahedronGeometry(12, 2);
            const coreMat = new THREE.MeshBasicMaterial({ 
                color: 0x00f3ff, 
                wireframe: true, 
                transparent: true, 
                opacity: 0.25 
            });
            const core = new THREE.Mesh(coreGeo, coreMat);
            cyberGroup.add(core);

            // 2. Inner Pulsing Core
            const innerGeo = new THREE.IcosahedronGeometry(5, 1);
            const innerMat = new THREE.MeshBasicMaterial({ 
                color: 0xbc13fe, 
                wireframe: true, 
                transparent: true, 
                opacity: 0.6 
            });
            const inner = new THREE.Mesh(innerGeo, innerMat);
            cyberGroup.add(inner);

            // 3. Rotating Rings
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff, transparent: true, opacity: 0.15, side: THREE.DoubleSide });
            
            const ring1 = new THREE.Mesh(new THREE.TorusGeometry(22, 0.1, 16, 100), ringMat);
            const ring2 = new THREE.Mesh(new THREE.TorusGeometry(28, 0.1, 16, 100), ringMat);
            const ring3 = new THREE.Mesh(new THREE.TorusGeometry(34, 0.1, 16, 100), ringMat);

            ring1.rotation.x = Math.PI / 1.8;
            ring2.rotation.y = Math.PI / 2.2;
            ring3.rotation.x = Math.PI / -2.5;

            cyberGroup.add(ring1);
            cyberGroup.add(ring2);
            cyberGroup.add(ring3);

            // 4. Orbiting Particles
            const pGeo = new THREE.BufferGeometry();
            const pCount = 800;
            const pPos = new Float32Array(pCount * 3);
            
            for(let i=0; i<pCount*3; i+=3) {
                const r = 40 + Math.random() * 40;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                pPos[i] = r * Math.sin(phi) * Math.cos(theta);
                pPos[i+1] = r * Math.sin(phi) * Math.sin(theta);
                pPos[i+2] = r * Math.cos(phi);
            }

            pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
            const pMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true, opacity: 0.4 });
            const particles = new THREE.Points(pGeo, pMat);
            scene.add(particles);

            // Mouse Interaction Vars
            let mouseX = 0;
            let mouseY = 0;
            let targetX = 0;
            let targetY = 0;
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX) * 0.001;
                mouseY = (event.clientY - windowHalfY) * 0.001;
            });

            const animate = () => {
                requestAnimationFrame(animate);

                targetX = mouseX * 0.5;
                targetY = mouseY * 0.5;

                cyberGroup.rotation.y += 0.002 + (targetX - cyberGroup.rotation.y) * 0.05;
                cyberGroup.rotation.x += 0.001 + (targetY - cyberGroup.rotation.x) * 0.05;
                core.rotation.y -= 0.005;
                core.rotation.z += 0.002;
                inner.rotation.y += 0.01;
                inner.rotation.x += 0.01;
                const time = Date.now() * 0.002;
                inner.scale.setScalar(1 + Math.sin(time) * 0.1);
                core.scale.setScalar(1 + Math.sin(time + 1) * 0.02);
                ring1.rotation.z += 0.002;
                ring2.rotation.z -= 0.003;
                ring3.rotation.z += 0.001;
                particles.rotation.y = -mouseX * 0.2;
                particles.rotation.x = -mouseY * 0.2;
                renderer.render(scene, camera);
            };

            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        // --- UI HELPERS ---
        lucide.createIcons();
        marked.setOptions({ highlight: (code) => code, breaks: true });

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const historyList = document.getElementById('history-list');

        const createMessageElement = (content, isUser = false, isTool = false) => {
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-4 max-w-3xl mx-auto opacity-0 animate-fade-in ${isUser ? 'flex-row-reverse' : ''}`;
            wrapper.style.animation = 'fadeIn 0.3s forwards';

            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded flex-shrink-0 flex items-center justify-center font-bold text-xs ${
                isUser 
                ? 'bg-gray-700 text-gray-200' 
                : isTool
                    ? 'bg-gradient-to-br from-pink-500 to-purple-600 text-white shadow-[0_0_15px_rgba(236,72,153,0.5)]'
                    : 'bg-gradient-to-br from-cyan-500 to-blue-600 text-white shadow-[0_0_15px_rgba(6,182,212,0.5)]'
            }`;
            avatar.innerHTML = isUser ? 'U' : isTool ? '<i data-lucide="sparkles" class="w-4 h-4"></i>' : 'Z';

            const msgBody = document.createElement('div');
            msgBody.className = 'space-y-1 max-w-[85%] min-w-[50%]';

            const name = document.createElement('div');
            name.className = `text-xs font-bold ${isUser ? 'text-gray-400 text-right' : isTool ? 'text-pink-400' : 'text-cyan-400'}`;
            name.textContent = isUser ? 'You' : isTool ? 'Zu Neural Tool' : 'Zu';

            const bubble = document.createElement('div');
            bubble.className = `msg-content p-4 rounded-2xl ${
                isUser 
                ? 'bg-white/10 text-white rounded-tr-none border border-white/10' 
                : 'glass-panel text-gray-200 rounded-tl-none'
            }`;
            
            if (!isUser) {
                bubble.innerHTML = marked.parse(content);
            } else {
                bubble.innerText = content;
            }

            msgBody.appendChild(name);
            msgBody.appendChild(bubble);
            wrapper.appendChild(avatar);
            wrapper.appendChild(msgBody);
            
            if(isTool) setTimeout(() => lucide.createIcons(), 0);
            return wrapper;
        };

        const createLoadingElement = () => {
            const wrapper = document.createElement('div');
            wrapper.id = 'loading-indicator';
            wrapper.className = 'flex gap-4 max-w-3xl mx-auto opacity-0 animate-fade-in';
            wrapper.style.animation = 'fadeIn 0.3s forwards';
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-blue-600 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs shadow-[0_0_15px_rgba(6,182,212,0.5)]';
            avatar.textContent = 'Z';
            const bubble = document.createElement('div');
            bubble.className = 'glass-panel p-4 rounded-2xl rounded-tl-none flex gap-1 items-center h-10';
            bubble.innerHTML = `<div class="typing-dot w-1.5 h-1.5 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 rounded-full"></div><div class="typing-dot w-1.5 h-1.5 rounded-full"></div>`;
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            return wrapper;
        };

        // --- STATE & HISTORY MANAGEMENT ---
        
        // Automated Status Checker
        const updateStatusDisplay = () => {
            const indicator = document.getElementById('status-indicator');
            const label = document.getElementById('status-label');
            const hasNet = navigator.onLine;
            const hasKey = (primaryKey && primaryKey.length > 10) || (secondaryKey && secondaryKey.length > 10);

            if (hasNet && hasKey) {
                isOnline = true;
                indicator.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] transition-all duration-300";
                label.innerText = "ONLINE";
                label.className = "text-xs font-mono text-green-400 transition-colors";
            } else {
                isOnline = false;
                indicator.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444] transition-all duration-300";
                label.innerText = !hasNet ? "NO NETWORK" : "INVALID KEY";
                label.className = "text-xs font-mono text-red-400 transition-colors";
            }
        };
        
        const checkStatusForce = () => {
            const label = document.getElementById('status-label');
            label.innerText = "CHECKING...";
            setTimeout(updateStatusDisplay, 500);
        }

        // Listen for network changes
        window.addEventListener('online', updateStatusDisplay);
        window.addEventListener('offline', updateStatusDisplay);

        const updateHistoryUI = () => {
            historyList.innerHTML = '';
            const sessionIds = Object.keys(savedSessions).sort().reverse();
            
            if (sessionIds.length === 0) {
                historyList.innerHTML = '<div class="text-center text-xs text-gray-600 py-4 italic">No recent cycles</div>';
                return;
            }

            sessionIds.forEach(id => {
                const session = savedSessions[id];
                const btn = document.createElement('button');
                const isActive = id === sessionId;
                const preview = session[0]?.parts[0]?.text.substring(0, 30) || "Empty Session";
                
                btn.className = `w-full text-left px-3 py-2.5 rounded-lg hover:bg-white/5 text-sm text-gray-300 transition-colors flex items-center gap-2 group history-item ${isActive ? 'active' : ''}`;
                btn.onclick = () => loadSession(id);
                btn.innerHTML = `
                    <i data-lucide="message-square" class="w-4 h-4 text-gray-500 group-hover:text-cyan-400"></i>
                    <span class="truncate">${preview}...</span>
                `;
                historyList.appendChild(btn);
            });
            lucide.createIcons();
        };

        const saveCurrentSession = () => {
            if (history.length > 0) {
                savedSessions[sessionId] = history;
                localStorage.setItem('zu_sessions', JSON.stringify(savedSessions));
                updateHistoryUI();
            }
        };

        const startNewChat = () => {
            sessionId = Date.now().toString();
            history = [];
            currentToolState = 'idle';
            chatContainer.innerHTML = '';
            
            const welcomeMsg = `System Online.<br>I am Zu (Core 1.0).<br>Running on <b>Dual-Core Architecture</b> (Primary Core + Auxiliary Fallback).`;
            chatContainer.appendChild(createMessageElement(welcomeMsg, false));
            updateHistoryUI();
        };

        const loadSession = (id) => {
            sessionId = id;
            history = savedSessions[id] || [];
            currentToolState = 'idle';
            chatContainer.innerHTML = '';
            
            history.forEach(msg => {
                const isUser = msg.role === 'user';
                const isTool = msg.role === 'tool';
                chatContainer.appendChild(createMessageElement(msg.parts[0].text, isUser, isTool));
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
            updateHistoryUI();
        };

        const clearHistory = () => {
            if(confirm("Wipe all memory banks?")) {
                savedSessions = {};
                localStorage.removeItem('zu_sessions');
                startNewChat();
            }
        };

        // --- API CALLS (DUAL CORE) ---

        // 1. Primary Core (Google)
        const callPrimaryCore = async (prompt, systemInstruction = null) => {
            if (!primaryKey) throw new Error("Primary Key Missing");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${primaryKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (systemInstruction) payload.systemInstruction = { parts: [{ text: systemInstruction }] };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(`Primary Core Error: ${response.status}`);
            }
            const data = await response.json();
            activeModel = "PRIMARY";
            return data.candidates[0].content.parts[0].text;
        };

        // 2. Auxiliary Core (OpenAI/Other)
        const callSecondaryCore = async (prompt, systemInstruction = null) => {
            if (!secondaryKey) throw new Error("Auxiliary Key Missing");

            const url = "https://api.openai.com/v1/chat/completions";
            const messages = [];
            if(systemInstruction) messages.push({ role: "system", content: systemInstruction });
            messages.push({ role: "user", content: prompt });

            const payload = {
                model: "gpt-3.5-turbo", 
                messages: messages,
                max_tokens: 500
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${secondaryKey}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(`Auxiliary Core Error: ${err.error?.message || response.status}`);
            }
            const data = await response.json();
            activeModel = "SECONDARY";
            return data.choices[0].message.content;
        };

        // 3. Fallback Orchestrator
        const getFlexibleResponse = async (prompt, systemInstruction) => {
            // Attempt 1: Primary
            try {
                console.log("Attempting Primary Core...");
                return await callPrimaryCore(prompt, systemInstruction);
            } catch (primaryError) {
                console.warn("Primary Core Failed:", primaryError.message);
                
                // Attempt 2: Secondary
                try {
                    console.log("Switching to Auxiliary Core...");
                    const reply = await callSecondaryCore(prompt, systemInstruction);
                    return `${reply}\n\n<span class="text-[10px] text-orange-400 font-mono">[AUXILIARY CORE ACTIVE]</span>`;
                } catch (secondaryError) {
                    console.error("Auxiliary Core Failed:", secondaryError.message);
                    throw new Error(`All Cores Failed. Primary: ${primaryError.message}. Auxiliary: ${secondaryError.message}`);
                }
            }
        };

        const callVisualCore = async (prompt) => {
            if (!primaryKey) throw new Error("Primary Key Missing.");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${primaryKey}`;
            const payload = { instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(err.error?.message || `Visual Core Error: ${response.status}`);
            }
            const data = await response.json();
            return `![Generated Image](data:image/png;base64,${data.predictions[0].bytesBase64Encoded})`;
        };

        // --- MAIN LOGIC ---

        const handleToolLogic = async (text) => {
            // Check Status
            if (!isOnline) {
                return new Promise(resolve => setTimeout(() => {
                    resolve("<b>[OFFLINE ERROR]</b><br>Core disconnected. Unable to process request.<br>Please check network connection and API key validity.");
                }, 800));
            }

            let reply = "";
            let prompt = "";
            let sysInst = "";

            if (currentToolState === 'visualizer_prompt') {
                reply = await callVisualCore(text);
                currentToolState = 'idle'; // Reset
                return reply;
            } 
            
            // For text-based tools, we use the Dual-Core logic
            if (currentToolState === 'strategist_prompt') {
                sysInst = "You are a Strategic Advisor. Create a markdown table with columns: 'Step', 'Action', 'Risk'.";
                prompt = `Create execution plan for: ${text}`;
                reply = await getFlexibleResponse(prompt, sysInst);
                currentToolState = 'idle';
                return reply;
            }

            if (currentToolState === 'code_weaver_prompt') {
                sysInst = "You are an expert Senior Software Engineer. Provide a robust, clean, and well-commented code solution in the requested language. Use Markdown code blocks.";
                prompt = `Generate code for: ${text}`;
                reply = await getFlexibleResponse(prompt, sysInst);
                currentToolState = 'idle';
                return reply;
            }

            if (currentToolState === 'mind_reader_prompt') {
                sysInst = "You are an expert in psychology and sentiment analysis. Analyze the following text for: 1. Emotional Tone 2. Subtext/Hidden Meaning 3. Psychological State of the author. Be concise but deep.";
                prompt = `Analyze this text: "${text}"`;
                reply = await getFlexibleResponse(prompt, sysInst);
                currentToolState = 'idle';
                return reply;
            }

            // Normal Chat
            history.push({ role: "user", parts: [{ text: text }] });
            const contextPayload = history.slice(-10);
            const historyText = contextPayload.map(m => `${m.role==='user'?'User':'Zu'}: ${m.parts[0].text}`).join('\n');
            
            // Using Dual-Core for normal chat
            reply = await getFlexibleResponse(
                `${historyText}\nZu:`, 
                "You are Zu, a high-tech 3D interface AI. You are helpful, precise, futuristic, and slightly mysterious. Be concise."
            );
            return reply;
        };

        const triggerTool = (type) => {
            if (!isOnline) { alert("System is OFFLINE. Connect to network first."); return; }
            
            let msg = "";
            if (type === 'visualizer') {
                currentToolState = 'visualizer_prompt';
                msg = "Visualizer Module Active. Please describe the construct you wish to generate.";
            } else if (type === 'strategist') {
                currentToolState = 'strategist_prompt';
                msg = "Strategist Module Active. Define the objective you need a plan for.";
            } else if (type === 'code_weaver') {
                currentToolState = 'code_weaver_prompt';
                msg = "Code Weaver Active. Describe the functionality or algorithm you need implemented.";
            } else if (type === 'mind_reader') {
                currentToolState = 'mind_reader_prompt';
                msg = "Mind Reader Active. Enter the text or conversation snippet you wish to analyze for subtext.";
            }

            const toolMsg = createMessageElement(msg, false, true);
            chatContainer.appendChild(toolMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            history.push({ role: "model", parts: [{ text: msg }] });
        };

        // --- FILE HANDLING ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                const snippet = `[Uploaded File: ${file.name}]\n${text}\n[End File]`;
                chatContainer.appendChild(createMessageElement(`<i>File '${file.name}' ingested into neural buffer.</i>`, false));
                history.push({ role: "user", parts: [{ text: snippet }] });
                saveCurrentSession();
            };
            reader.readAsText(file);
        });

        // --- EVENT HANDLERS ---
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            // 1. UI Update
            chatContainer.appendChild(createMessageElement(text, true));
            userInput.value = '';
            userInput.style.height = 'auto';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 2. Loading
            const loader = createLoadingElement();
            chatContainer.appendChild(loader);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // 3. Logic
                const responseText = await handleToolLogic(text);
                
                // 4. Save Response
                history.push({ role: "model", parts: [{ text: responseText }] });
                
                loader.remove();
                chatContainer.appendChild(createMessageElement(responseText));
                chatContainer.scrollTop = chatContainer.scrollHeight;
                saveCurrentSession();

            } catch (error) {
                loader.remove();
                chatContainer.appendChild(createMessageElement(`**System Error:** ${error.message}`));
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });

        // --- INIT ---
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }`;
        document.head.appendChild(styleSheet);

        initThreeJS();
        updateStatusDisplay();
        startNewChat(); 

    </script>
</body>
</html>